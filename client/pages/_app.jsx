import Head from 'next/head'
import { useRouter } from 'next/router'
import React, { useEffect, useState } from 'react'
import Header from '../components/Header'
import { AuthProvider, getUser } from '../contexts/Auth.context'
import '../styles/globals.css'

function MyApp({ Component, pageProps }) {
  const [auth, setAuth] = useState({ status: 'SIGNED_OUT', user: null })
  const router = useRouter()
  const authCondition = auth.status === 'SIGNED_OUT'
  const privateRoutes = ['/profile', '/dashboard']
  const routeCondition = privateRoutes.includes(router.pathname)

  useEffect(() => {
    if (authCondition) {
      getUser().then(res => {
        if (res.status !== 'SIGNED_OUT') {
          return setAuth(res)
        } else {
          if (routeCondition) router.push('/')
        }
      })
    }
  }, [auth])

  useEffect(() => {
    console.log(auth)
  }, [auth])
  return (
    <React.Fragment>
      <Head>
        <meta charset='utf-8' />
        <meta name='description' content='Generated by create next app' />
        <link rel='icon' href='/favicon.ico' />
        <title>Next.js app</title>
      </Head>
      <AuthProvider myAuth={auth}>
        <Header />
        <Component {...pageProps} />
      </AuthProvider>
    </React.Fragment>
  )
}

export default MyApp
